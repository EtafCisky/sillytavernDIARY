# 日记本插件 (sillytavernDIARY)

**版本**: 3.3.0  
**作者**: Etaf Cisky  
**适配**: SillyTavern 1.12.0+  
**状态**: 稳定版本  
**许可证**: CC BY-NC-ND 4.0

---

## ⚠️ 重要版权声明

**本插件采用 CC BY-NC-ND 4.0 许可协议，原作者为 Etaf Cisky。**

### 📜 使用条款

任何人在使用、分发本插件时，**必须遵守以下规定**：

1. ✅ **保留原作者署名**：必须明确标注原作者为 `Etaf Cisky`
2. ❌ **禁止商业使用**：不得用于任何商业目的（包括但不限于销售、收费服务等）
3. ❌ **禁止修改**：不得修改、改编或演绎本作品
4. ✅ **允许分享**：可以自由复制和分发原始作品

### ⚖️ 法律责任

- **删除或伪造作者信息、商业使用、修改作品均违反 CC BY-NC-ND 4.0 许可协议**
- 违反者将面临法律追责
- 本项目在 GitHub 上有完整的提交历史可供验证原创性

### 🔗 官方仓库

- **GitHub**: [https://github.com/EtafCisky/sillytavernDIARY](https://github.com/EtafCisky/sillytavernDIARY)
- **作者**: Etaf Cisky
- **Copyright**: © 2025 Etaf Cisky. All rights reserved.

---

## 🎯 简介

日记本插件是一个功能完善的 SillyTavern 扩展，为您的角色对话提供完整的日记管理系统。通过智能的AI交互和优雅的界面设计，让日记记录变得轻松而有趣。

### ✨ 核心特色

- 📝 **智能写日记** - AI自动生成格式化的日记内容
- 🤖 **自动写日记** - 按楼层数自动触发，分角色独立计数
- 📚 **日记本管理** - 按角色分类浏览和管理所有日记
- 🗑️ **一键删除** - 安全删除不需要的日记
- 👤 **自定义角色** - 为任意角色写日记，不限于当前角色卡
- 🎨 **主题切换** - 经典/简洁/夜间三种视觉风格随心切换
- 📱 **移动端优化** - 完整的响应式设计，支持各种屏幕尺寸
- 🎯 **悬浮窗设计** - 可拖拽的圆形悬浮窗，不影响聊天体验
- 📖 **在线文档** - 设置页面内置完整使用文档查看器

---

## 📦 安装说明

### 方法一：通过 SillyTavern 内置安装器（推荐）

1. 打开 SillyTavern，进入 **扩展** 页面
2. 点击 **安装插件** 按钮
3. 在弹出的输入框中粘贴插件仓库地址：

   ```
   https://github.com/EtafCisky/sillytavernDIARY
   ```

4. 点击确认，等待自动下载和安装
5. 重启 SillyTavern 或刷新页面
6. 在聊天页面应该能看到可拖拽的圆形悬浮窗（📖图标）

### 方法二：手动安装

1. 从 GitHub 下载插件：[https://github.com/EtafCisky/sillytavernDIARY](https://github.com/EtafCisky/sillytavernDIARY)
2. 将整个 `sillytavernDIARY` 文件夹复制到以下目录：

   ```
   SillyTavern/public/scripts/extensions/third-party/
   ```

3. 重启 SillyTavern 或在扩展管理页面点击 "重新加载"
4. 在聊天页面应该能看到可拖拽的圆形悬浮窗（📖图标）

### 方法三：Git 克隆

```bash
cd [SillyTavern安装目录]/public/scripts/extensions/third-party/
git clone https://github.com/EtafCisky/sillytavernDIARY.git sillytavernDIARY
```

然后重启 SillyTavern 或重新加载扩展。

### 验证安装

安装成功后，您应该能看到：

- ✅ 在"扩展"页面能看到"📖 日记本"插件
- ✅ 在聊天页面能看到圆形悬浮窗
- ✅ 点击悬浮窗能展开三个功能按钮（📖日记本、✏️写日记、📝记录）

---

## 🚀 快速开始

### 第一步：选择主题

1. 打开 **扩展设置** 页面
2. 找到 **📖 日记本** 插件
3. 在 **🎨 主题美化** 区域选择喜欢的主题：
   - **经典** - 古典书本风格，皮革质感，金色装饰 ⭐默认
   - **简洁** - 现代简约设计，清爽界面
   - **夜间** - 深色护眼主题，极光渐变，星空美学 🌙新增

### 第二步：开始写日记

1. 在聊天页面找到圆形悬浮窗
2. 点击悬浮窗展开三个功能按钮
3. 点击 **✏️ 写日记** 按钮
4. 在弹出的对话框中：
   - 输入自定义角色名（可选）
   - 或直接点击"发送"使用当前角色卡名称
5. AI 将自动生成日记内容
6. 日记自动保存到世界书系统

### 第三步：浏览日记本

1. 点击悬浮窗的 **📖 日记本** 按钮
2. 选择角色查看该角色的所有日记
3. 点击任意日记卡片查看完整内容
4. 点击 **🗑️ 删除日记** 按钮可删除当前日记

---

## 📚 功能详解

### 1. ✏️ 写日记功能

#### 功能说明

引导AI按照标准格式创作日记，自动保存到世界书系统。

#### 使用步骤

1. **点击"写日记"按钮** → 弹出角色选择窗口
2. **选择角色**：
   - 输入自定义角色名：为任意角色写日记
   - 留空直接发送：使用当前角色卡名称
3. **等待AI生成** → 系统自动发送日记命令给AI
4. **自动解析保存** → AI回复后自动提取日记内容并保存
5. **聊天记录清理** → 自动删除日记命令和回复（保持聊天整洁）

#### 日记格式

```
［日记标题：今天的心情］
［日记时间：2025年10月5日］
［日记内容：今天天气很好，和朋友一起去了公园...］
```

#### 注意事项

- ✅ 支持任意角色名，不限于当前角色卡
- ✅ 日记自动按角色分类存储
- ✅ 重复标题会覆盖旧日记
- ✅ 聊天记录自动清理，不影响后续对话

### 2. 📝 记录功能

#### 功能说明

手动解析聊天中已存在的日记内容并保存，适用于：

- AI已经回复了日记但未自动保存
- 批量处理历史日记内容
- 写日记功能失败后的补救

#### 使用步骤

1. 确保聊天中最新消息包含日记格式内容
2. 点击 **📝 记录** 按钮
3. 系统自动解析最新消息并保存
4. 显示成功提示

### 3. 📖 日记本功能

#### 浏览日记

1. **打开日记本** → 点击"日记本"按钮
2. **封面页** → 显示统计信息：
   - 📊 日记总数
   - 👥 角色数量
3. **角色列表** → 点击"打开日记本"进入
   - 显示所有有日记的角色
   - 每个角色卡片显示日记数量
4. **日记列表** → 点击角色卡片查看该角色的日记
   - 按时间排序显示
   - 分页浏览（每页10篇）
5. **日记详情** → 点击日记卡片查看完整内容
   - 显示标题、时间、内容
   - 支持删除操作

#### 删除日记

1. 在日记详情页
2. 点击 **🗑️ 删除日记** 按钮
3. 确认删除
4. 日记从世界书中永久删除

#### 导航操作

- **返回按钮** - 返回上一级页面
- **分页按钮** - 浏览更多日记
- **关闭按钮** - 关闭日记本弹窗

### 4. 🎨 主题切换

#### 可用主题

| 主题名称   | 风格         | 特点                                                                                             |
| ---------- | ------------ | ------------------------------------------------------------------------------------------------ |
| **经典 ⭐** | 古典书本风格 | • 精致的皮革质感背景<br>• 华丽的金色装饰效果<br>• 纸张纹理和装订线细节<br>• 古典字体和优雅动画   |
| **简洁**   | 现代简约设计 | • 清爽的白色界面<br>• 流畅的交互体验<br>• 简洁的卡片布局<br>• 现代化的渐变色彩                   |
| **夜间 🌙** | 深色护眼主题 | • 深邃的星空背景色<br>• 青蓝色极光渐变<br>• 六边形几何设计<br>• 3D变换与流动光效<br>• 移动端优化 |

#### 切换方法

1. 打开 **扩展设置** → **📖 日记本**
2. 在 **🎨 主题美化** 区域
3. 从下拉菜单选择主题
4. 主题立即切换并自动保存

#### 主题说明

每个主题下方会显示详细描述，帮助您了解主题特点。主题选择会自动保存，下次启动时恢复。

### 5. ⚙️ 预设管理

#### 功能说明

配置专用的日记写作预设，优化AI的日记生成效果。

#### 使用方法

1. 在扩展设置中点击 **配置预设** 按钮
2. 在弹出窗口中选择预设
3. 系统显示当前使用的预设名称

> **提示**: 预设功能可以让您为不同角色或风格设置不同的日记生成规则。

### 6. 🤖 自动写日记功能

#### 功能说明

自动写日记功能可以在聊天达到指定楼层数时，自动触发日记生成。无需手动操作，让日记记录更加自然流畅。

#### 配置步骤

1. 打开 **扩展设置** → **📖 日记本**
2. 在 **自动写日记** 区域找到 **触发间隔（楼层数）** 输入框
3. 输入数字N（建议使用偶数，如10、12、16）
4. 系统立即启用，显示状态信息

#### 工作原理

- **楼层计数**：每条消息（包括用户和AI）都计入楼层数
- **触发时机**：当前楼层 - 上次触发楼层 ≥ N时自动触发
- **起始楼层**：输入N时的当前楼层作为起始点
- **分角色独立**：每个角色单独计数和记录
- **智能检测**：等待AI回复完成后才触发，避免冲突

#### 使用示例

假设您在第15楼设置间隔为10：

- 起始楼层：15
- 第一次触发：第25楼（15+10）
- 第二次触发：第35楼（25+10）
- 以此类推...

#### 状态显示

- **功能未启用** - 未设置间隔或间隔为0
- **已启用，还需X条消息触发** - 显示距离下次触发的剩余楼层数
- **已达触发条件** - 已达到触发条件，等待合适时机执行

#### 禁用方法

在触发间隔输入框中删除数字或输入0即可禁用。

#### 注意事项

- ✅ 建议输入偶数，避免在用户发送消息后立即执行
- ✅ 功能启用后会在后台每3秒检查一次
- ✅ 检测到AI正在生成时会自动跳过，等待下次检查
- ✅ 切换角色时，每个角色独立计数
- ✅ 自动写日记完成后会自动清理聊天记录

### 7. 🎯 悬浮窗控制

#### 悬浮窗功能

- **拖拽移动** - 长按悬浮窗可拖拽到任意位置
- **展开/收起** - 点击切换菜单显示/隐藏
- **位置记忆** - 自动保存窗口位置
- **智能交互** - 拖拽时不会触发菜单

#### 控制选项

- **显示/隐藏悬浮窗** - 在设置中切换悬浮窗可见性
- **重置位置** - 将悬浮窗恢复到默认位置

### 8. 📖 在线文档查看

#### 功能说明

在插件设置页面的"使用帮助"标签页，可以直接查看完整的使用文档，无需离开SillyTavern。

#### 使用方法

1. 打开 **扩展设置** → **📖 日记本**
2. 切换到 **使用帮助** 标签
3. 点击右侧的 **📖 阅读完整文档** 按钮
4. 弹窗会在屏幕中央显示完整的README文档

#### 功能特点

- ✅ 弹窗居中显示，阅读体验优良
- ✅ 支持Markdown格式渲染
- ✅ 可滚动查看所有内容
- ✅ 点击外部区域或按ESC键关闭
- ✅ 移动端自动适配

---

## 🔧 技术细节

### 存储系统

#### 世界书集成

- 所有日记存储在名为 **"日记本"** 的世界书中
- 自动创建和管理，无需手动操作

#### 存储格式

```javascript
{
  comment: "标题-时间",     // 条目名称
  key: ["角色名"],          // 关键词（角色名）
  content: "实际日记内容"    // 条目内容
}
```

#### 分类机制

- 按角色名作为关键词分类
- 支持自定义角色名
- 同一角色的日记自动归类

### 智能特性

#### 内容解析

- 使用正则表达式智能提取日记内容
- 自动过滤模板格式（如 `{{标题}}` 等）
- 验证内容有效性，防止空日记

#### 自动清理

- 保存成功后自动删除日记命令和AI回复
- 保持聊天记录整洁
- 防止误删保护机制

#### 错误处理

- 完整的异常捕获和用户提示
- 详细的控制台日志
- 友好的错误信息

---

## 👨‍💻 开发者指南

### 添加新主题

想要为插件创建自己的主题？按以下步骤操作：

#### 1. 创建 CSS 文件

在插件目录创建新的 CSS 文件：

```
sillytavernDIARY/style-mytheme.css
```

#### 2. 注册主题

编辑 `index.js`，在 `THEMES` 对象中添加：

```javascript
const THEMES = {
    classic: { ... },
    simple: { ... },
    
    // 添加新主题
    mytheme: {
        id: 'mytheme',                    // 唯一ID
        name: '我的主题',                  // 显示名称
        description: '这是一个很棒的主题',  // 主题描述
        cssFile: 'style-mytheme.css'      // CSS文件名
    }
};
```

#### 3. 设计样式

新主题 CSS 必须包含以下样式：

> **⚠️ 重要说明**：插件设置页面样式（`.diary-plugin-settings` 及相关样式）已统一管理在 `index.js` 文件中，无需在新主题CSS文件中重复定义。这确保了无论选择哪个主题，插件设置页面的外观都保持一致。

**必需样式类：**

- `.diary-float-window` - 悬浮窗
- `.diary-custom-character-dialog` - 自定义角色弹窗
- `.diary-book-dialog` - 日记本弹窗
- `.diary-preset-dialog` - 预设管理弹窗
- `.diary-book-character-list` - 角色列表
- `.diary-book-diary-list` - 日记列表
- `.diary-book-detail` - 日记详情

**推荐结构：**

```css
/* 注意：不要包含插件设置页面样式，这些已在 index.js 中统一管理 */

/* ===== 悬浮窗样式 ===== */
.diary-float-window { ... }

/* ===== 弹窗样式 ===== */
.diary-custom-character-dialog { ... }
.diary-book-dialog { ... }
.diary-preset-dialog { ... }

/* ===== 页面视图样式 ===== */
.diary-book-character-list { ... }
.diary-book-diary-list { ... }
.diary-book-detail { ... }

/* ===== 响应式设计 ===== */
@media (max-width: 768px) { ... }
```

#### 4. 参考资料

- **经典主题**: 参考 `style-classic.css`
- **简洁主题**: 参考 `style-simple.css`
- **夜间主题**: 参考 `style-night.css`
- **HTML 结构**: 参考 `index.html`

### 技术实现

#### 主题加载机制

```javascript
// 启动时
loadSettings() → loadPluginSettingsStyle() + loadTheme(selectedTheme)

// 切换时
用户选择 → switchTheme(themeId) → loadTheme(themeId) + 保存设置

// CSS加载
loadTheme() → 移除旧CSS → 创建新CSS → 添加到<head>
loadPluginSettingsStyle() → 创建内联样式 → 添加到<head>
```

#### 插件设置页面样式管理

从v3.0版本开始，插件设置页面的样式已从各个主题CSS文件中提取出来，统一管理在 `index.js` 的 `PLUGIN_SETTINGS_CSS` 常量中。这样做的好处是：

- **一致性**：无论选择哪个主题，设置页面外观都保持一致
- **维护性**：只需在一个地方修改设置页面样式
- **扩展性**：添加新主题时无需重复定义设置页面样式

```javascript
// 设置页面样式加载流程
初始化 → loadPluginSettingsStyle() → 创建<style>元素 → 应用PLUGIN_SETTINGS_CSS
```

#### API 集成

```javascript
// 世界书操作
import { loadWorldInfo, saveWorldInfo, createWorldInfoEntry } from "world-info.js";

// 聊天操作
import { sendMessageAsUser, Generate, chat } from "script.js";

// 命令系统
import { executeSlashCommandsWithOptions } from "slash-commands.js";
```

---

## 🐛 故障排查

### 主题相关问题

#### 主题切换后样式不生效

1. 检查浏览器开发者工具的 Network 标签，确认 CSS 文件已加载
2. 检查 CSS 文件路径是否正确
3. 清除浏览器缓存后重试
4. 查看控制台是否有 CSS 语法错误

#### 主题选择不保存

1. 检查浏览器的 LocalStorage 是否被禁用
2. 查看控制台是否有保存错误信息
3. 尝试重启 SillyTavern

### 功能相关问题

#### 写日记后没有保存

1. 检查 AI 回复是否包含正确的日记格式
2. 打开控制台查看详细日志
3. 检查世界书 "日记本" 是否被手动删除
4. 尝试使用"记录"功能手动保存

#### 日记本打开后无内容

1. 确认已经写过至少一篇日记
2. 检查世界书 "日记本" 中是否有条目
3. 查看控制台是否有加载错误

#### 悬浮窗不显示

1. 检查扩展是否正确安装
2. 在设置中点击 "显示/隐藏悬浮窗"
3. 点击 "重置悬浮窗位置"
4. 刷新页面

#### AI 生成的日记格式不正确

1. 检查是否配置了专用的日记预设
2. 在预设中添加日记格式说明
3. 使用“记录”功能可以解析任意包含标准格式的内容

### 获取帮助

如果问题仍未解决：

1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签中的错误信息
3. 复制错误信息并报告问题
4. 提供操作步骤和截图

---

## 📄 许可证

本项目采用 **CC BY-NC-ND 4.0 许可协议**。

### 完整许可证文本

详见项目根目录的 `LICENSE` 文件或访问：  
<https://creativecommons.org/licenses/by-nc-nd/4.0/>

### 重要提示

- ✅ 本项目允许非商业性分享
- ✅ 必须保留原作者署名（Etaf Cisky）
- ✅ 必须包含完整的许可证文本
- ❌ 禁止商业使用（包括销售、收费服务等）
- ❌ 禁止修改、改编或演绎本作品
- ❌ 不得删除或篡改作者信息

任何违反许可证条款的行为都将受到法律追究。

---

## 🙏 致谢

感谢 SillyTavern 团队提供优秀的扩展 API 系统。

---

## 🛡️ 版权保护声明

### 关于代码盗用

如果您发现任何人在未经许可的情况下：

- 删除或修改了原作者署名
- 声称本插件为其原创作品
- 在分发时未包含许可证文件

请通过以下方式举报：

1. 在 GitHub 仓库提交 Issue
2. 联系原作者 Etaf Cisky
3. 提供盗用者的链接和证据

### 验证插件真实性

您可以通过以下方式验证插件的真实性：

1. **检查文件头部**：所有主要代码文件（如 `index.js`）都包含详细的版权声明
2. **检查 manifest.json**：`author` 字段应为 `"Etaf Cisky"`
3. **检查 LICENSE 文件**：应包含完整的 CC BY-NC-ND 4.0 许可协议文本和版权声明
4. **检查 GitHub 历史**：官方仓库有完整的提交历史记录
5. **检查设置页面**：插件设置的"使用帮助"标签页底部包含完整的作者信息

### 官方发布渠道

- **唯一官方仓库**: [https://github.com/EtafCisky/sillytavernDIARY](https://github.com/EtafCisky/sillytavernDIARY])
- **作者**: Etaf Cisky
- **插件指纹**: `EC-STD-2025` (用于版本验证)

---

**💡 提示**: 如果您喜欢这个插件，欢迎分享给朋友或提供反馈建议！

**🔗 相关链接**:

- [插件 GitHub 仓库](https://github.com/EtafCisky/sillytavernDIARY)
- [SillyTavern 官方文档](https://docs.sillytavern.app/)

---

## 📝 更新日志

### v3.3.0 (2025-11-23)

#### 🤖 自动写日记功能

- ✨ **全新自动写日记** - 按楼层数自动触发日记生成
  - 可配置触发间隔（楼层数N）
  - 分角色独立计数和记录
  - 智能等待AI回复完成
  - 自动清理日记命令和回复
  - 实时状态显示

#### 📖 在线文档查看

- ✨ **README阅读弹窗** - 在插件设置页面直接查看完整文档
  - 使用帮助标签页添加"阅读完整文档"按钮
  - 弹窗居中显示，阅读体验优良
  - 支持Markdown格式渲染
  - 移动端自动适配
  - 多种关闭方式（关闭按钮、外部点击、ESC键）

#### ⚙️ 配置管理

- 🎨 **UI改进** - 移除世界书配置区域
- 📊 **状态监控** - 实时显示剩余楼层数
- 💾 **持久化存储** - 楼层记录自动保存
- 🔧 **智能起始** - 设置时当前楼层作为起始点

#### 🐛 问题修复

- 🛡️ **防冲突保护** - 检测AI生成状态，避免重复触发
- 🎯 **精确计数** - 基于楼层记录方案，避免立即触发
- 📝 **用户友好** - 添加偶数输入提示

#### 🔧 技术改进

- 🔄 **定时检查** - 每3秒自动检查楼层变化
- 📦 **模块化设计** - 新增多个辅助函数
- 📋 **详细日志** - 完善的控制台日志输出
- 🎨 **弹窗居中优化** - 使用flex布局确保所有弹窗正确居中

---

### v3.2.5 (2025-11-16)

#### 🌙 夜间主题重大更新

- ✨ **全新夜间主题** - 深色护眼设计，适合夜间使用
  - 深邃星空背景 + 青蓝极光渐变
  - 六边形几何元素 + 3D变换效果
  - 流动光效 + 星点装饰
  - 柔和色彩 + 低对比度护眼设计

#### 🎨 视觉优化

- 🔧 **作者目录优化** - “篇日记”文字颜色设置为浅灰蓝色
- 🔧 **日记目录优化** - 日记名称和时间使用统一浅灰蓝色
- 🎨 **预设配置页面美化** - 完整的夜间主题适配
  - 信息框渐变设计
  - 预设卡片三种状态（普通/系统当前/已选择）
  - 徽章呼吸动画
  - 分隔线装饰效果
  - 空状态页面
  - 分页控制组件

#### 🐛 移动端修复

- 📱 **修复封面闪烁** - 解决日记本封面在手机上的闪烁问题
  - 禁用移动端背景动画提升性能
  - 保留六边形按钮动画效果
  - 优化移动端渲染性能

#### 🔧 技术改进

- 🎯 **颜色统一管理** - 防止继承酒馆UI颜色
- 💫 **动画性能优化** - 移动端智能禁用高消耗动画
- 📐 **样式代码优化** - 完善CSS变量系统

---

*最后更新: 2025-11-23*  
*维护者: Etaf Cisky*
